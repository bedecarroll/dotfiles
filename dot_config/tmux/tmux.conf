# vim:fileencoding=utf-8:ft=conf:foldmethod=marker
# https://tmuxcheatsheet.com/
# http://www.hamvocke.com/blog/a-guide-to-customizing-your-tmux-conf/
# https://devhints.io/tmux
# https://mdschreier.com/2018/03/01/tmux-logging-and-preserving-sessions/
# https://www.man7.org/linux/man-pages/man1/tmux.1.html

# Terminal Overrides {{{

# Might need to change this on systems that don't have the terminfo installed
# Check with find /usr/share/terminfo -type f -print | grep tmux
# tmux-256color instead of screen-256color enables italics
set-option -g default-terminal "tmux-256color"

# Underlying terminal supports OSC 52 so force on
# https://github.com/tmux/tmux/wiki/Clipboard
set-option -as terminal-overrides ',*256col*:Ms=\E]52;%p1%s;%p2%s\007'
set-option -as terminal-overrides ',alacritty*:Ms=\E]52;%p1%s;%p2%s\007'

# Fix inputrc block only in command mode issue
# https://github.com/tmux/tmux/issues/1684
set-option -as terminal-overrides ",*256col*:Ss=\\E[%p1%d q:Se=\\E[2 q"

# Tc enables true color
set-option -ag terminal-overrides ",*256col*:colors=256:Tc:smso"
set-option -ag terminal-overrides ",alacritty*:colors=256:Tc:smso"

# Enable UTF-8 support
# https://github.com/tmux/tmux/wiki/FAQ#why-are-tmux-pane-separators-dashed-rather-than-continuous-lines
set-option -as terminal-overrides ",*:U8=0"

# }}}
# Misc {{{

set-option -g mouse on
set-option -g history-limit 100000
set-option -g display-time 2000
set-option -s escape-time 0
set-window-option -g aggressive-resize on

# On both makes tmux set the clipboard for the outside terminal, and allows applications
# inside tmux to set tmux's clipboard (adding a paste buffer)
set-option -g set-clipboard on

# }}}
# Title {{{

set-option -g set-titles on
set-option -g set-titles-string '#H:#S.#I.#P #W #T'

# }}}
# Shorcuts {{{

bind-key S command-prompt -p ssh: "new-window -n %1 'ssh %1'"
bind-key | split-window -h -c '#{pane_current_path}'
bind-key - split-window -v -c '#{pane_current_path}'
bind-key e set-window-option synchronize-panes
bind-key ] paste-buffer -p
bind-key r {
  source-file ~/.tmux.conf
  display "Config reloaded"
}
bind-key -n S-Left {
  swap-window -t -1
  select-window -t -1
}
bind-key -n S-Right {
  swap-window -t +1
  select-window -t +1
}

# }}}
# VI Mode {{{

set-option -g status-keys vi
set-window-option -g mode-keys vi
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R
bind-key -r C-h select-window -t :-
bind-key -r C-l select-window -t :+
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

# }}}
# Index {{{

# Disable base-index so IRC window can be 0
# set-option -g base-index 1
set-option -g renumber-windows on
set-window-option -g pane-base-index 1

# }}}
# Visual bell {{{

set-option -g visual-activity on
set-option -g visual-bell on
set-option -g visual-silence on
set-option -g bell-action any
set-window-option -g monitor-activity on

# }}}
# Statusbar {{{

set-option -g status-position top
set-option -g status-justify left
set-option -g status-left ''
set-option -g status-right '#(echo #{pane_current_path} | sed -E "s|$HOME|~|g")'
set-option -g status-right-length 80
set-option -g status-interval 2
# Disabled these because the window names moving in the center were annoying
# set-option -g status-justify center
# set-option -g status-left-length 20

# }}}
# Styles {{{
# Color list: https://jonasjacek.github.io/colors/
# Standard colors to use:
# Black = colour0
# Red = colour9
# White = colour15
# Blue = colour14
# Grey = colour7
# Dark Grey = colour235

# Modes

set-window-option -g clock-mode-colour colour15

# When you go into copy mode
set-window-option -g mode-style fg=colour9,bg=colour7,bold

# Panes

set-option -g pane-border-style fg=colour235,bg=colour0,none
set-option -g pane-active-border-style fg=colour14,bg=colour0,none

# Statusbar

# Status bar default text color and background
set-option -g status-style fg=colour7,bg=colour0,dim

# Window status

# Default text colour and background for the window names at the bottom
set-window-option -g window-status-style fg=colour7,bg=colour0,none
set-window-option -g window-status-format ' #I:#W#F '

set-window-option -g window-status-current-style fg=colour7,bg=colour0,bold
set-window-option -g window-status-current-format ' #[fg=colour14]#I#[fg=colour7]:#[fg=colour15]#W#[fg=colour14]#F '

set-window-option -g window-status-bell-style fg=colour15,bg=colour9,bold

# When a non-focused window has activity/message
set-window-option -g window-status-activity-style fg=colour15,bg=colour0,none

# Messages

# When you go into command mode you get this
set-option -g message-style fg=colour15,bg=colour9,bold

# When you hit esc in command mode you get this
set-option -g message-command-style fg=colour14,bg=colour0,none

# Old theme
# set-window-option -g clock-mode-colour white
# set-window-option -g mode-style fg=colour196,bg=colour238,bold
# set-option -g pane-border-style fg=colour238,bg=colour235,none
# set-option -g pane-active-border-style fg=colour51,bg=colour236,none
# set-option -g status-style fg=colour137,bg=colour234,dim
# set-window-option -g window-status-style fg=colour138,bg=colour235,none
# set-window-option -g window-status-format ' #I#[fg=colour237]:#[fg=colour250]#W#[fg=colour244]#F '
# set-window-option -g window-status-current-style fg=colour81,bg=colour238,bold
# set-window-option -g window-status-current-format ' #I#[fg=colour250]:#[fg=colour255]#W#[fg=colour50]#F '
# set-window-option -g window-status-bell-style fg=colour255,bg=colour1,bold
# set-option -g message-style fg=colour232,bg=colour166,bold
# set-option -g message-command-style fg=blue,bg=black,none

# }}}
# Imports {{{

# Only active when in a local terminal
if-shell 'test -z "$SSH_CLIENT"' {
  # Modified from:
  # https://github.com/samoshkin/tmux-config/blob/master/tmux/tmux.conf#L350-L381

  # Override status style as this will be show when key bindings are enabled
  set-option -g status-style fg=colour7,bg=colour235,bold

  # Settings to enable local/outer session (reset key bindings to default)
  bind-key -T off F12 {
    set-option -u prefix
    set-option -u key-table
    set-option -u status-style
    refresh-client -S
  }

  # Settings to disable local/outer session key bindings
  bind-key -T root F12 {
    set-option prefix None
    set-option key-table off
    set-option status-style fg=colour7,bg=colour0,dim
    if -F '#{pane_in_mode}' 'send-keys -X cancel'
    refresh-client -S
  }

  # }}}
}

# Rmoete SSH session specific config
if-shell 'test -n "$SSH_CLIENT"' {
  # Yank {{{

  # transfer copied text to attached terminal with yank
  bind-key -T copy-mode-vi Y send-keys -X copy-pipe 'yank > #{pane_tty}'

  # transfer most-recently copied text to attached terminal with yank
  bind-key -n M-y run-shell 'tmux save-buffer - | yank > #{pane_tty}'

  # transfer previously copied text (chosen from a menu) to attached terminal
  bind-key -n M-Y choose-buffer 'run-shell "tmux save-buffer -b \"%%%\" - | yank > #{pane_tty}"'

  # }}}
  # Statusbar {{{

  set-option -g status-position bottom

  # }}}
}

# Import here if in a newer tmux version to prevent double import
if-shell '[ $(echo "$TMUX_VERSION >= 3.1" | bc) = 1 ]' {
  source-file "${XDG_CONFIG_HOME}/tmux/${HOSTNAME}/tmux.conf"
}

# }}}
